---
# https://github.com/linuxserver/docker-homarr#parameters

- name: "Prepare task variables"
  ansible.builtin.set_fact:
    homarr_service_id: "homarr"
    homarr_docker_settings: "{{ homarr_docker_settings_default | combine(homarr_docker_settings, recursive=true) }}"

- name: "Make sure config directories exist"
  ansible.builtin.file:
    path: "{{ homarr_install_dir }}/{{ item }}"
    state: "directory"
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: "0774"
  with_items:
    - "configs"
    - "icons"
    - "data"

- name: "Make sure {{ homarr_docker_settings.network }} docker network exists"
  when: homarr_docker_settings.network != "host"
  community.general.docker_network:
    name: "{{ homarr_docker_settings.network }}"
    state: "present"

- name: "Run homarr container"
  community.general.docker_container:
    name: "{{ homarr_service_id }}"
    image: "ghcr.io/ajnart/homarr:{{ homarr_version }}"
    networks:
      - name: "{{ homarr_docker_settings.network }}"
    state: "started"
    healthcheck: "{{ homarr_docker_settings.healthcheck }}"
    env: "{{ homarr_env_default | combine(homarr_env) }}"
    ports:
      - "{{ homarr_port }}:7575"
    volumes:
      - "{{ homarr_install_dir }}/configs:/app/data/configs"
      - "{{ homarr_install_dir }}/icons:/app/public/icons"
      - "{{ homarr_install_dir }}/data:/data"
    restart_policy: "unless-stopped"
